<link href="/sys/polymer/polymer.html" rel="import">

  <link rel="import" href="/sys/iron-flex-layout/iron-flex-layout.html">
<dom-module id="tu-signin-avatar">
  <style>
      .vertical {
          @apply(--layout);
          @apply(--layout-vertical);
      }

      .horizontal {
          @apply(--layout);
          @apply(--layout-horizontal);
      }

      .wrap {
          @apply(--layout-wrap);
      }

      .center {
          @apply(--layout-center);
      }
    :host {
	        color: rgb(255, 255, 255);
	        font-family: robotodraft;
	        display: inline-flex;
  	        flex-direction: column;
	        height: auto;
	        line-height: 32.5px;
	        text-align: center;
	        width: auto;
        }

        #popupTarget {
	        height: 1px;
	        width: 1px;
        }

        .avatar_background {
  	        margin-right:2px;
  	        border-radius: 50%;	
	        -webkit-user-select: none;
	        border: 2px solid rgba(255,255,255,0.7);
	       
	        color: rgb(68, 68, 68);
	        display: block;
	        float: left;
	        margin-bottom: 1px;
	        margin-left: 2px;
	        margin-right: 2px;
	        margin-top: 1px;
	        /*overflow: hidden;*/
	        position: relative;
	        text-decoration: none solid rgb(68, 68, 68);
	        text-decoration-color: rgb(68, 68, 68);
	        text-decoration-line: none;
	        text-decoration-style: solid;
	        z-index: 0;
        }

        .avatar_background img {	
  	        border-radius: 49%;	
        }

        .avatar_background[draggable=true]
        {
	        cursor:-webkit-grab;
	        -webkit-user-drag: element;
        }

        .avatar_background.responsible {
	        /*
	        border: 2px solid rgba(0,0,0,0.4);
	        box-shadow: rgba(0,0,0,0.6) 2px 2px 3px;
	        */
        }

        #popup {
          background-color: white;
          font-size: 12px;
          font-weight: 500;
          border: #999 1px solid;
          border-radius: 25%;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3), 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .deleteme:hover
        {
	        color: red;
            cursor: not-allowed;
        }

        .avatar_initials
        {
	        color: #fff;
	
	        display: block;
	        font-size: {{size/2}}px;
	        font-weight: bold;
	        left: 0px;
	        /*overflow-x: hidden;
	        overflow-y: hidden;*/
	        position: absolute;
	        text-align: center;
	        top: 0px;
	        line-height:{{size}}px;
  	        width:{{size}}px;
  	        height:{{size}}px;
        }
  </style>
  <template>
        <div on-click="onClicked" on-tap="onTapped" id="avatardrag" 
            class="horizontal center center-justified" class$="{{_computeClass(responsible)}}">                
                <template is="dom-if" if="{{_computeIf(type)}}">
                    <img id="theImg" height="{{size}}" src="{{_computeSrc(gravatar, size)}}" title="{{fullname}}">
                </template>
                <template is="dom-if" if="{{_computeIf2(forceInitials, type)}}">
                    <span id="theInitials" class="avatar_initials" title="{{fullname}}">{{initials}}</span>
                </template>
        </div>
  </template>
  <script type="text/javascript">
      'use strict';
      Polymer({
          is: 'tu-signin-avatar',
          properties: {
              _open: {
                  type: Boolean,
                  value: false
              },
              color: {
                  type: String,
                  value: 'rgba(0,0,0,0.3)'
              },
              deleteable: {
                  type: Boolean,
                  value: false,
                  notify: true
              },
              dropdown: {
                  type: Boolean,
                  value: false,
                  notify: true
              },
              forceInitials: {
                  type: Boolean,
                  value: false
              },
              fullname: {
                  type: String,
                  value: 'Nobody Here'
              },
              gravatar: {
                  type: String,
                  value: ''
              },
              initials: {
                  type: String,
                  value: 'n/a',
                  notify: true
              },
              moreAlternative: {
                  type: String,
                  value: '',
                  notify: true
              },
              moreTap: {
                  type: String,
                  value: '',
                  notify: true
              },
              pid: {
                  type: String,
                  value: '',
                  notify: true
              },
              responsible: {
                  type: Boolean,
                  value: false,
                  notify: true,
                  observer: 'responsibleChanged'
              },
              size: {
                  type: Number,
                  value: 32,
                  notify: true,
                  observer: 'sizeChanged'
              },
              type: {
                  type: String,
                  value: 'color'
              },
              value: {
                  type: String,
                  value: '',
                  notify: true,
                  observer: 'valueChanged',
                  reflectToAttribute: true
              }
          },
          ready: function () {
              var that = this;
              this.$.avatardrag.addEventListener('dragstart', function (ev) {
                  ev.dataTransfer.setData('person', that.pid);
                  ev.stopPropagation();
              });
          },
          onTapped: function (ev) {
              if (this.dropdown) {
                  this._opened = true;
                  ev.stopImmediatePropagation();
              }
          },
          onClicked: function (ev) {
              if (this.dropdown) {
                  ev.stopImmediatePropagation();
              }
          },
          onClosed: function (ev) {
              //First when closed can we manipulate values
              if (this.oSelected) {
                  if (this.oSelected.value == 'moreTap') {
                      this.moreTap++;
                      this._opened = false;
                  } else {
                  }
                  //this.value = this.oSelected.value;
                  this.oSelected.tapIt();
                  this.oSelected = false;
              }
          },
          sizeChanged: function () {
              this.$.avatardrag.style.width = this.size > 0 ? this.size + "px" : "inherit";
              this.$.avatardrag.style.height = this.size > 0 ? this.size + "px" : "inherit";
              if (this.$.theImg) {
                  this.$.theImg.style.width = this.size > 0 ? this.size + "px" : "inherit";
                  this.$.theImg.style.height = this.size > 0 ? this.size + "px" : "inherit";
              }
              if (this.$.theInitials) {
                  this.$.theInitials.style.width = this.size > 0 ? this.size + "px" : "inherit";
                  this.$.theInitials.style.height = this.size > 0 ? this.size + "px" : "inherit";
                  this.$.theInitials.style.fontSize = this.size > 0 ? this.size / 2 + "px" : "inherit";
              }
          },
          optionSelected: function (ev) {
              this.oSelected = ev.detail;
              //we need to start by closing core-overlay to replace component
              this._opened = false;
          },
          valueChanged: function (_, e) {
              var res = this.value.split('{;}');
              for (var i = 0; i < res.length; i++) {
                  var parts = res[i].split('{:}');
                  if (parts.length > 1) {
                      switch (parts[0]) {
                          case 'name':
                              this.parseName(parts[1]);
                              break;
                          case 'type':
                              this.parseType(parts[1]);
                              break;
                          case 'value':
                              this.parseValue(parts[1]);
                              break;
                      }
                  }
              }
          },
          parseName: function (thename) {
              this.fullname = thename;
              var res = thename.split(' ');
              if (res.length >= 2) {
                  this.initials = res[0].substring(0, 1) + res[res.length - 1].substring(0, 1);
              } else {
                  this.initials = thename.substring(0, 2);
              }
          },
          parseType: function (thetype) {
              this.type = thetype;
          },
          parseValue: function (thevalue) {
              switch (this.type) {
                  case 'gravatar':
                      this.gravatar = thevalue;
                      break;
                  case 'color':
                      this.color = thevalue;
                      break;
              }
          },
          responsibleChanged: function (_, e) {
          },
          _computeClass: function (responsible) {
              return 'avatar_background ' + (responsible ? 'responsible' : '');
          },
          _computeIf: function (type) {
              return type == 'gravatar';
          },
          _computeIf2: function (forceInitials, type) {
              return !(type == 'gravatar') || forceInitials;
          },
          _computeSrc: function (gravatar, size) {
              return 'http://www.gravatar.com/avatar/' + gravatar + '&s=' + size*2;
          }
      });
  </script>
</dom-module>

