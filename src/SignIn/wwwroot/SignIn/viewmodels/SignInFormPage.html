<link rel="import" href="/sys/puppet-redirect/puppet-redirect.html" />
<link rel="import" href="/sys/gold-email-input/gold-email-input.html" />
﻿<link rel="import" href="/SignIn/elements/signin-element.html" />


<template>
  <style>
    #loginBackground {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #loginBox {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }

    #header {
      width: 100%;
      background-image: linear-gradient(-195deg, #1eaef8 25%, #1782fa 65%);
      border-radius: 5px;
      padding: 10px;
      display: flex;
      flex-direction: row;
      align-items: center;
    }

    #headertxt {
      color: white;
      font-size: 20px;
      margin-left: 35px;
    }

    #logologin {
      width: 63px;
      height: 56px;
      background: url(/SignIn/images/cl-logo-fff.png);
      background-size: contain;
      background-repeat: no-repeat;
      transition: all 300ms ease-in 0s;
    }

    #logologin:hover {
      opacity: .5;
    }


    .with-margin {
      padding: 10px;
    }

        #remember_me {
            margin-right: 5px;
        }

        #remember_me_div {
            display: flex;
            color: #BBBBBB;
        }


        @keyframes invalid
        {
          0% {transform: rotate(2deg);box-shadow: 5px 5px 5px #888888;}
          5% {transform: rotate(5deg);box-shadow: 10px 10px 10px #888888;}
          10% {transform: rotate(-5deg);box-shadow: 10px 10px 10px #888888;}
          30% {transform: rotate(2deg);box-shadow: 5px 5px 5px #888888;}
          60% {transform: rotate(-2deg);box-shadow: 5px 5px 5px #888888;}
          100% {transform: rotate(0deg);box-shadow: 0px 0px #888888;}
        }


       .shake
        {
          animation:invalid 0.5s;
        }

        .flexbox #info-box
        {
          display: none !important;
        }

        .alert {
            color: red;
        }

        #info-box
        {
          border: 2px solid red;
          display: block
        }


        form {
          display: flex;
          flex-direction: column;
          align-items: center;
        }

        #txtUsername {
          min-width: 250px;
        }
        #txtPassword {
          min-width: 250px;
        }
        #txtEmail {
          min-width: 250px;
        }

        div.formButtonRow {
          display: flex;
          flex-direction: row;
          width: 100%;
          align-items: center;
          margin-top: 15px;
        }

        paper-button {
          font-family: roboto;
        }

        paper-button.primary {
          background-color: #1782fa;
          color: white;
          padding: 5px 5px;
          margin: 0px;
        }

        paper-button.secondary {
          color: #1782fa;
          opacity: 0.7;
          font-size: 12px;
          padding-left: 0px;
          margin-left: 0px;
        }

        div.spacer {
          flex:1;
        }

    </style>
    <template is="dom-bind">
      <div id="loginBackground">
        <div class$="[[calculateClass(model.Message, model.FailedLoginCount)]]" id="loginBox" hidden="[[model.IsSignedIn]]">
            <div id="header">
              <div id="logologin"></div>
              <span id="headertxt">[[_calcHeaderText(model.Message, model.ForgotPassword$)]]</span>
            </div>
            <form on-submit="preventSubmit" hidden$="[[model.ForgotPassword$]]">
              <template is="dom-if" if="[[model.Message]]">
                <p class="alert alert-danger">[[model.Message]]</p>
              </template>
              <paper-input autofocus tabindex="1" id="txtUsername" type="text" on-keydown="checkForNameEnter" value="{{local.username}}" label="Email or username">
                <co-icon prefix style="margin-right:5px" icon="envelope"></co-icon>
              </paper-input>
              <paper-input tabindex="2" id="txtPassword" type="password" on-keydown="checkForPassEnter" value="{{local.password}}" label="Password">
                <co-icon prefix style="margin-right:5px" icon="lock"></co-icon>
              </paper-input>
              <div class="formButtonRow">
                <paper-button tabindex="4" on-tap="toggleForgotPassword" class="secondary">Forgot password</paper-button>
                <div class="spacer"></div>
                <paper-button tabindex="3" id="signinButton" raised class="primary" on-tap="signIn">
                  <co-icon style="margin-right:5px" icon="sign-in"></co-icon>
                  Sign in
                </paper-button>
              </div>
            </form>
            <form on-submit="preventSubmit" hidden$="[[_shallSend(model.Message, model.ForgotPassword$)]]">
              <template is="dom-if" if="{{model.Message}}">
                <p class="alert alert-danger">{{model.Message}}</p>
              </template>
              <gold-email-input autofocus tabindex="1" id="txtEmail" required error-message="Please enter a valid email address" type="text" on-keydown="checkForForgotNameEnter" value="{{local.username}}" label="Email">
                <co-icon prefix style="margin-right:5px" icon="envelope"></co-icon>
              </gold-email-input>
              <div class="formButtonRow">
                <paper-button tabindex="4" on-tap="toggleForgotPassword" class="secondary">Back to login</paper-button>
                <div class="spacer"></div>
                <paper-button tabindex="3" id="requestButton" raised class="primary" on-tap="requestPassword">
                  <co-icon style="margin-right:5px" icon="envelope-square"></co-icon>
                  Request
                </paper-button>
              </div>
            </form>
            <div class="form" hidden$="[[_sendSuccess(model.Message, model.ForgotPassword$)]]">
              <span>A request for a new password has been sent to your email account.<br>Note that depending on the email server it might take up to a few minutes before the email arrives<span>
              <div class="formButtonRow">
                <div class="spacer"></div>
                <paper-button tabindex="1" autofocus on-tap="toggleForgotPassword" raised class="primary">Back to login</paper-button>
              </div>
            </div>
        </div>
        <signin-element username="{{local.username}}" password="{{local.password}}" remember-me="{{local.RememberMe$}}" submit="{{model.Submit}}" session-uri="{{model.SessionUri}}"></signin-element>
      </div>
    </template>
    <script>
        (function () {
            var script = document._currentScript || document.currentScript;
            var template = script.previousElementSibling;

            template.local = {
                password: "",
                username:"",
                rememberMe: false
            };

            template.preventSubmit = function(e) {
              e.preventDefault();
            };

            template.txtKeypress = function (e) {
                if (e.which != 13) {
                    return;
                }
            };

            template.calculateClass = function (d, count) {
                //element.classList.remove("run-animation");
                var that = this;
                this.$.loginBox.classList.remove("shake");

                if(d != "")
                {
                  setTimeout(function(){that.$.loginBox.classList.add("shake");}, 10);
                }

                return d ? "shake"+count: "noshake";
            };

            template.signIn = function () {
                setTimeout(function () {
                    template.set("model.SignInClick$", template.model.SignInClick$ + 1);
                    window.tu.puppetDirtyCheck();
                });
            }

            template.checkForNameEnter = function(e) {
              if (e.keyCode === 13) {
                this.$.txtPassword.focus();
              }
            };

            template.checkForPassEnter = function(e) {
              if (e.keyCode === 13) {
                this.signIn();
              }
            };

            template.checkForForgotNameEnter = function(e) {
              if (e.keyCode === 13) {
                this.requestPassword();
              }
            };

            template.requestPassword = function() {
              var valid = this.$.txtEmail.validate();
              if (valid) {
                setTimeout(function () {
                    template.set('model.Username$', template.local.username);
                    template.set("model.SubmitForgotPassword$", template.model.SubmitForgotPassword$ + 1);
                    window.tu.puppetDirtyCheck();
                });
              };
           };

            template.toggleForgotPassword = function() {
              template.set('model.ForgotPassword$', !template.model.ForgotPassword$);
              if (template.model.ForgotPassword$) {
                this.$.txtUsername.focus();
              }
              else {
                this.$.txtEmail.validate();
                this.$.txtEmail.focus();
              }
            };

            template._sendSuccess = function(msg, fp) {
              return !fp || msg != "success";
            };

            template._shallSend = function(msg, fp) {
              return !fp || msg == "success";
            };

            template._calcHeaderText = function(msg, fp) {
              if (!fp)
                return "Sign in";
              else if (msg == "success")
                return "Request sent!";
              else
                return "New password";
            };
        })();
    </script>
</template>
